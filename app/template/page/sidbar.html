<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darslik Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/b99e675b6e.js"></script>
    <style>
        .lesson-content {
            line-height: 1.8;
        }
        .lesson-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 16px 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .lesson-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .lesson-content table td {
            padding: 12px;
            border: 1px solid #e5e7eb;
        }
        .lesson-content table tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .lesson-content h1, .lesson-content h2, .lesson-content h3 {
            font-weight: bold;
            margin: 24px 0 16px 0;
            color: #1f2937;
        }
        .lesson-content h1 { font-size: 2rem; }
        .lesson-content h2 { font-size: 1.5rem; }
        .lesson-content h3 { font-size: 1.25rem; }
        .lesson-content p {
            margin: 12px 0;
            color: #374151;
        }
        .lesson-content a {
            color: #3b82f6;
            text-decoration: underline;
            transition: color 0.2s;
        }
        .lesson-content a:hover {
            color: #1d4ed8;
        }
        .lesson-content blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 16px;
            margin: 16px 0;
            font-style: italic;
            background: #f8fafc;
            padding: 16px;
            border-radius: 0 8px 8px 0;
        }
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .dropdown-arrow {
            transition: transform 0.2s ease-in-out;
        }
        .dropdown-arrow.rotate {
            transform: rotate(180deg);
        }
        .sidebar-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .sidebar-scrollbar::-webkit-scrollbar-track {
            background: #374151;
        }
        .sidebar-scrollbar::-webkit-scrollbar-thumb {
            background: #6b7280;
            border-radius: 2px;
        }
        .content-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tooltip {
            position: relative;
        }
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
        }
        .bookmark-btn {
            transition: all 0.2s ease;
        }
        .bookmark-btn.bookmarked {
            color: #f59e0b;
        }
        .notes-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .notes-panel.open {
            max-height: 200px;
        }
        .theme-toggle {
            transition: background-color 0.3s ease;
        }
        .fullscreen-reading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-btn" class="lg:hidden fixed top-4 left-4 z-50 bg-gray-900 text-white p-2 rounded-lg">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-gray-900 text-white sidebar-scrollbar overflow-y-auto transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out fixed lg:relative h-full z-40">
            <div class="p-4 border-b border-gray-800">
                <div class="flex items-center justify-between">
                    <i class="fas fa-graduation-cap text-2xl text-indigo-400"></i>
                    <span class="text-xl font-bold">Darslik Pro</span>
                    <button id="close-sidebar" class="lg:hidden text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="p-4 bg-gray-800 m-4 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-400">Umumiy jarayon</span>
                    <div class="relative w-8 h-8">
                        <svg class="w-8 h-8 progress-ring">
                            <circle cx="16" cy="16" r="14" fill="transparent" stroke="#374151" stroke-width="2"/>
                            <circle id="progress-circle" cx="16" cy="16" r="14" fill="transparent" stroke="#3b82f6" stroke-width="2" 
                                    stroke-dasharray="87.96" stroke-dashoffset="87.96" class="progress-ring-circle"/>
                        </svg>
                        <span id="progress-percent" class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white">0%</span>
                    </div>
                </div>
                <div class="text-xs text-gray-400">
                    <span id="completed-lessons">0</span> / <span id="total-lessons">0</span> dars yakunlandi
                </div>
            </div>

            <!-- Search Bar -->
            <div class="p-4">
                <div class="relative">
                    <input type="text" id="search-input" class="w-full bg-gray-800 text-white rounded-md pl-10 pr-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Qidirish...">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-500"></i>
                    </div>
                    <button id="clear-search" class="absolute inset-y-0 right-0 pr-3 hidden text-gray-500 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <nav class="mt-2 px-2">
                <!-- Course Info -->
                <div class="space-y-1" id="course-section">
                    <button class="w-full flex items-center justify-between px-4 py-2.5 text-sm font-medium rounded-lg bg-gray-800 text-white group transition-all duration-200 hover:bg-gray-700" aria-expanded="true" aria-controls="course-dropdown">
                        <div class="flex items-center">
                            <i class="fas fa-book mr-3"></i>
                            <span id="course-title">Kurs yuklanyapti...</span>
                        </div>
                        <i class="fas fa-chevron-down dropdown-arrow rotate"></i>
                    </button>
                    <div class="space-y-1 pl-4" id="course-dropdown">
                        <div id="course-info" class="p-3 text-xs text-gray-400 loading bg-gray-800 rounded">
                            <div class="h-3 bg-gray-700 rounded mb-1"></div>
                            <div class="h-3 bg-gray-700 rounded w-3/4 mb-1"></div>
                            <div class="h-2 bg-gray-700 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>

                <!-- Chapters -->
                <div class="space-y-1 mt-4">
                    <button class="w-full flex items-center justify-between px-4 py-2.5 text-sm font-medium rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white focus:outline-none transition-all duration-200" aria-expanded="false" aria-controls="chapters-dropdown">
                        <div class="flex items-center">
                            <i class="fas fa-list mr-3"></i>
                            <span>Boblar</span>
                            <span id="chapters-count" class="ml-2 px-2 py-0.5 bg-gray-700 text-xs rounded-full">0</span>
                        </div>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </button>
                    <div class="hidden space-y-1 pl-4" id="chapters-dropdown">
                        <div id="chapters-list">
                            <div class="loading space-y-2">
                                <div class="h-8 bg-gray-800 rounded"></div>
                                <div class="h-8 bg-gray-800 rounded"></div>
                                <div class="h-8 bg-gray-800 rounded"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Current Lessons -->
                <div class="space-y-1 mt-4" id="lessons-section" style="display: none;">
                    <button class="w-full flex items-center justify-between px-4 py-2.5 text-sm font-medium rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white focus:outline-none transition-all duration-200" aria-expanded="false" aria-controls="lessons-dropdown">
                        <div class="flex items-center">
                            <i class="fas fa-play-circle mr-3"></i>
                            <span id="current-chapter-title">Darslar</span>
                            <span id="lessons-count" class="ml-2 px-2 py-0.5 bg-gray-700 text-xs rounded-full">0</span>
                        </div>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </button>
                    <div class="hidden space-y-1 pl-4" id="lessons-dropdown">
                        <div id="lessons-list"></div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="mt-8 px-4">
                    <div class="text-xs text-gray-400 mb-2 uppercase tracking-wide">Tez amallar</div>
                    <div class="space-y-2">
                        <button id="bookmark-btn" class="w-full flex items-center px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white rounded-md transition-all duration-200">
                            <i class="fas fa-bookmark mr-3"></i>
                            Xatcho'plar
                        </button>
                        <button id="notes-btn" class="w-full flex items-center px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white rounded-md transition-all duration-200">
                            <i class="fas fa-sticky-note mr-3"></i>
                            Eslatmalar
                        </button>
                        <button id="fullscreen-btn" class="w-full flex items-center px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white rounded-md transition-all duration-200">
                            <i class="fas fa-expand mr-3"></i>
                            Toliq ekran
                        </button>
                    </div>
                </div>
            </nav>

            <!-- User Profile -->
            <div class="mt-auto p-4 border-t border-gray-800">
                <div class="flex items-center">
                    <div class="h-8 w-8 bg-indigo-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-white text-sm"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-white">O'quvchi</p>
                        <p class="text-xs text-gray-400">Onlayn</p>
                    </div>
                    <button class="ml-auto text-gray-400 hover:text-white">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 bg-gray-100 flex flex-col lg:ml-0">
            <!-- Header -->
            <header class="bg-white shadow-sm border-b">
                <div class="px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h1 id="main-title" class="text-2xl font-semibold text-gray-900">Darslik Dashboard</h1>
                            <div class="flex items-center mt-1 space-x-2">
                                <p id="main-subtitle" class="text-gray-600">Darsni tanlang va o'rganishni boshlang</p>
                                <div id="reading-time" class="hidden text-sm text-gray-500">
                                    <i class="fas fa-clock mr-1"></i>
                                    <span>5 daqiqa</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <!-- Quick Tools -->
                            <div class="hidden lg:flex items-center space-x-2">
                                <button id="bookmark-current" class="tooltip bookmark-btn p-2 text-gray-600 hover:text-yellow-500 transition-colors" data-tooltip="Xatcho'pga qo'shish">
                                    <i class="fas fa-bookmark"></i>
                                </button>
                                <button id="font-size-btn" class="tooltip p-2 text-gray-600 hover:text-gray-900 transition-colors" data-tooltip="Shrift o'lchami">
                                    <i class="fas fa-text-height"></i>
                                </button>
                                <button id="print-btn" class="tooltip p-2 text-gray-600 hover:text-gray-900 transition-colors" data-tooltip="Chop etish">
                                    <i class="fas fa-print"></i>
                                </button>
                            </div>
                            
                            <!-- Navigation -->
                            <div class="flex items-center space-x-2">
                                <button id="prev-lesson" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200" disabled>
                                    <i class="fas fa-chevron-left mr-2"></i>
                                    <span class="hidden sm:inline">Oldingi</span>
                                </button>
                                <span id="lesson-counter" class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium">
                                    0 / 0
                                </span>
                                <button id="next-lesson" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200" disabled>
                                    <span class="hidden sm:inline">Keyingi</span>
                                    <i class="fas fa-chevron-right ml-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes Panel -->
                <div id="notes-panel" class="notes-panel bg-yellow-50 border-t border-yellow-200">
                    <div class="px-6 py-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-medium text-gray-900">Eslatmalar</h3>
                            <button id="close-notes" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <textarea id="lesson-notes" class="w-full h-20 p-3 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Bu dars haqida eslatma yozing..."></textarea>
                        <div class="flex justify-end mt-2">
                            <button id="save-notes" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm">
                                Saqlash
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto">
                <div class="max-w-4xl mx-auto p-6">
                    <div id="lesson-content" class="bg-white rounded-lg shadow-md">
                        <div class="p-8">
                            <div class="text-center py-16">
                                <i class="fas fa-book-open text-6xl text-gray-300 mb-4"></i>
                                <h3 class="text-xl font-medium text-gray-500 mb-2">Darslikka xush kelibsiz!</h3>
                                <p class="text-gray-400 mb-6">Chap tarafdan bobni tanlang va o'rganishni boshlang</p>
                                <div class="flex items-center justify-center space-x-4 text-sm text-gray-500">
                                    <div class="flex items-center">
                                        <i class="fas fa-keyboard mr-2"></i>
                                        <span>‚Üê ‚Üí tugmalari bilan navigatsiya</span>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fas fa-search mr-2"></i>
                                        <span>Qidirish imkoniyati</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Font Size Modal -->
    <div id="font-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-80">
            <h3 class="text-lg font-medium mb-4">Shrift sozlamalari</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">O'lcham:</label>
                    <input type="range" id="font-range" min="12" max="24" value="16" class="w-full">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>Kichik</span>
                        <span>Katta</span>
                    </div>
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="reset-font" class="px-4 py-2 text-gray-600 hover:text-gray-800">Qaytarish</button>
                    <button id="close-font-modal" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Yopish</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay for mobile -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden hidden"></div>

    <!-- Admin Panel for Data Management -->
    <div id="admin-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium">Ma'lumotlarni boshqarish</h3>
                <button id="close-admin-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Course Data -->
                <div class="border rounded-lg p-4">
                    <h4 class="font-medium mb-2">Kurs ma'lumotlari</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kurs nomi:</label>
                            <input type="text" id="admin-course-title" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kurs haqida:</label>
                            <textarea id="admin-course-body" class="w-full p-2 border rounded h-20"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Chapters Management -->
                <div class="border rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium">Boblar</h4>
                        <button id="add-chapter-btn" class="px-2 py-1 bg-indigo-600 text-white rounded text-sm">
                            <i class="fas fa-plus mr-1"></i> Qo'shish
                        </button>
                    </div>
                    <div id="admin-chapters-list" class="space-y-2 max-h-40 overflow-y-auto">
                        <!-- Chapters will be listed here -->
                    </div>
                </div>
                
                <!-- Lessons Management -->
                <div class="border rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium">Darslar</h4>
                        <div class="flex items-center space-x-2">
                            <select id="chapter-select" class="p-1 border rounded text-sm">
                                <option value="">Bob tanlang</option>
                            </select>
                            <button id="add-lesson-btn" class="px-2 py-1 bg-indigo-600 text-white rounded text-sm" disabled>
                                <i class="fas fa-plus mr-1"></i> Qo'shish
                            </button>
                        </div>
                    </div>
                    <div id="admin-lessons-list" class="space-y-2 max-h-40 overflow-y-auto">
                        <!-- Lessons will be listed here -->
                    </div>
                </div>
                
                <!-- Import/Export -->
                <div class="border rounded-lg p-4">
                    <h4 class="font-medium mb-2">Import/Export</h4>
                    <div class="flex space-x-2">
                        <button id="export-data-btn" class="px-3 py-2 bg-gray-200 text-gray-800 rounded text-sm">
                            <i class="fas fa-download mr-1"></i> Export
                        </button>
                        <button id="import-data-btn" class="px-3 py-2 bg-gray-200 text-gray-800 rounded text-sm">
                            <i class="fas fa-upload mr-1"></i> Import
                        </button>
                        <input type="file" id="import-file" class="hidden" accept=".json">
                    </div>
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button id="reset-data-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">
                        Tozalash
                    </button>
                    <button id="save-data-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm">
                        Saqlash
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lesson Editor Modal -->
    <div id="lesson-editor-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium" id="lesson-editor-title">Dars tahrirlash</h3>
                <button id="close-lesson-editor" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Dars raqami:</label>
                    <input type="number" id="lesson-editor-number" class="w-full p-2 border rounded" min="1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Dars matni:</label>
                    <textarea id="lesson-editor-body" class="w-full p-2 border rounded h-60 font-mono"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="cancel-lesson-edit" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 text-sm">
                        Bekor qilish
                    </button>
                    <button id="save-lesson-edit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm">
                        Saqlash
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class AdvancedCourseApp {
            constructor() {
                this.courseId = 1;
                this.currentChapter = null;
                this.currentLessonIndex = 0;
                this.lessons = [];
                this.chapters = [];
                this.bookmarks = this.loadBookmarks();
                this.notes = this.loadNotes();
                this.completedLessons = this.loadProgress();
                this.settings = this.loadSettings();
                
                // Sample data for initial setup if localStorage is empty
                this.sampleData = {
                    course: {
                        id: 1,
                        title: "Web Dasturlash Asoslari",
                        body: "Ushbu kursda web dasturlash asoslari o'rgatiladi. HTML, CSS va JavaScript texnologiyalari bilan tanishasiz.",
                        created_at: new Date().toISOString()
                    },
                    chapters: [
                        {
                            id: 1,
                            title: "HTML asoslari",
                            lessonCount: 3
                        },
                        {
                            id: 2,
                            title: "CSS asoslari",
                            lessonCount: 2
                        }
                    ],
                    lessons: {
                        1: [
                            {
                                id: 1,
                                body: "<h1>HTML nima?</h1><p>HTML (HyperText Markup Language) - veb-sahifalarni yaratish uchun ishlatiladigan standart belgilash tili.</p><p>HTML elementlari veb-sahifaning asosiy qurilish bloklaridir.</p>",
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            },
                            {
                                id: 2,
                                body: "<h1>HTML elementlari</h1><p>HTML elementlari ochilish va yopilish teglari bilan belgilanadi.</p><p>Masalan: <code>&lt;p&gt;Bu paragraf&lt;/p&gt;</code></p>",
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            },
                            {
                                id: 3,
                                body: "<h1>HTML atributlari</h1><p>HTML elementlari qo'shimcha ma'lumotlarni taqdim etish uchun atributlarga ega bo'lishi mumkin.</p><p>Masalan: <code>&lt;a href='https://example.com'&gt;Havola&lt;/a&gt;</code></p>",
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            }
                        ],
                        2: [
                            {
                                id: 4,
                                body: "<h1>CSS nima?</h1><p>CSS (Cascading Style Sheets) - veb-sahifalarning ko'rinishini boshqarish uchun ishlatiladigan uslublar tili.</p>",
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            },
                            {
                                id: 5,
                                body: "<h1>CSS selektorlari</h1><p>CSS selektorlari uslublanadigan HTML elementlarini tanlash uchun ishlatiladi.</p><p>Masalan: <code>p { color: red; }</code> barcha paragraflarni qizil rangga o'zgartiradi.</p>",
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            }
                        ]
                    }
                };
                
                this.init();
            }

            async init() {
                this.initializeLocalStorage();
                await this.loadCourse();
                await this.loadChapters();
                this.setupEventListeners();
                this.setupDropdowns();
                this.setupMobileMenu();
                this.setupKeyboardShortcuts();
                this.setupAutoSave();
                this.setupAdminPanel();
                this.applySettings();
            }

            // Initialize localStorage with sample data if empty
            initializeLocalStorage() {
                if (!localStorage.getItem('course_data')) {
                    localStorage.setItem('course_data', JSON.stringify(this.sampleData.course));
                }
                
                if (!localStorage.getItem('chapters_data')) {
                    localStorage.setItem('chapters_data', JSON.stringify(this.sampleData.chapters));
                }
                
                if (!localStorage.getItem('lessons_data')) {
                    localStorage.setItem('lessons_data', JSON.stringify(this.sampleData.lessons));
                }
            }

            // Data Loading Methods
            async loadCourse() {
                try {
                    const courseData = JSON.parse(localStorage.getItem('course_data'));
                    
                    document.getElementById('course-title').textContent = courseData.title;
                    document.getElementById('course-info').innerHTML = `
                        <div class="text-xs">
                            <div class="text-gray-300 font-medium mb-2">${courseData.title}</div>
                            <div class="text-gray-400 mb-2">üìÖ ${new Date(courseData.created_at).toLocaleDateString('uz-UZ')}</div>
                            <div class="text-gray-400 text-xs leading-relaxed">${courseData.body}</div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Kursni yuklashda xatolik:', error);
                    this.showError('Kursni yuklashda xatolik yuz berdi');
                }
            }

            async loadChapters() {
                try {
                    const chapters = JSON.parse(localStorage.getItem('chapters_data'));
                    this.chapters = chapters;
                    
                    document.getElementById('chapters-count').textContent = chapters.length;
                    
                    const chaptersHTML = chapters.map((chapter, index) => `
                        <a href="#" 
                           class="group flex items-center justify-between px-4 py-2.5 text-sm text-gray-300 rounded-md hover:bg-gray-700 hover:text-white chapter-link transition-all duration-200"
                           data-chapter-id="${chapter.id}">
                            <div class="flex items-center">
                                <i class="fas fa-circle text-xs mr-3 opacity-50"></i>
                                <span>${index + 1}. ${chapter.title}</span>
                            </div>
                            <i class="fas fa-chevron-right text-xs opacity-50"></i>
                        </a>
                    `).join('');
                    
                    document.getElementById('chapters-list').innerHTML = chaptersHTML;
                } catch (error) {
                    console.error('Boblarni yuklashda xatolik:', error);
                    this.showError('Boblarni yuklashda xatolik yuz berdi');
                }
            }

            async loadChapterLessons(chapterId) {
                try {
                    this.showLoadingSpinner();
                    
                    const lessonsData = JSON.parse(localStorage.getItem('lessons_data'));
                    const chapterData = this.chapters.find(chapter => chapter.id === chapterId);
                    
                    if (!chapterData) {
                        throw new Error('Bob topilmadi');
                    }
                    
                    this.currentChapter = chapterData;
                    this.lessons = lessonsData[chapterId] || [];
                    this.currentLessonIndex = 0;
                    
                    this.updateUI(chapterData);
                    this.generateLessonsList();
                    this.updateActiveStates(chapterId);
                    
                    if (this.lessons.length > 0) {
                        this.showLesson(0);
                    }
                    
                    this.updateProgress();
                    this.hideLoadingSpinner();
                    
                } catch (error) {
                    console.error('Darslarni yuklashda xatolik:', error);
                    this.showError('Darslarni yuklashda xatolik yuz berdi');
                    this.hideLoadingSpinner();
                }
            }

            // UI Update Methods
            updateUI(chapterData) {
                document.getElementById('main-title').textContent = chapterData.title;
                document.getElementById('main-subtitle').textContent = `${this.lessons.length} ta dars mavjud`;
                document.getElementById('current-chapter-title').textContent = chapterData.title;
                document.getElementById('lessons-count').textContent = this.lessons.length;
                document.getElementById('lessons-section').style.display = 'block';
            }

            generateLessonsList() {
                const lessonsHTML = this.lessons.map((lesson, index) => {
                    const isCompleted = this.completedLessons.includes(this.getLessonId(lesson, index));
                    const hasBookmark = this.bookmarks.includes(this.getLessonId(lesson, index));
                    const hasNotes = this.notes[this.getLessonId(lesson, index)];
                    
                    return `
                        <a href="#" 
                           class="group flex items-center justify-between px-4 py-2.5 text-sm text-gray-300 rounded-md hover:bg-gray-700 hover:text-white lesson-link transition-all duration-200"
                           data-lesson-index="${index}">
                            <div class="flex items-center">
                                <i class="fas fa-${isCompleted ? 'check-circle text-green-500' : 'play text-indigo-400'} text-xs mr-3"></i>
                                <span>Dars ${index + 1}</span>
                                <div class="flex items-center ml-2 space-x-1">
                                    ${hasBookmark ? '<i class="fas fa-bookmark text-yellow-500 text-xs" title="Xatcho\'p"></i>' : ''}
                                    ${hasNotes ? '<i class="fas fa-sticky-note text-blue-500 text-xs" title="Eslatma bor"></i>' : ''}
                                </div>
                            </div>
                            <span class="text-xs opacity-50">${this.estimateReadingTime(lesson.body)} min</span>
                        </a>
                    `;
                }).join('');
                
                document.getElementById('lessons-list').innerHTML = lessonsHTML;
            }

            showLesson(index) {
                if (index < 0 || index >= this.lessons.length) return;
                
                const lesson = this.lessons[index];
                this.currentLessonIndex = index;
                const lessonId = this.getLessonId(lesson, index);
                
                // Mark as completed
                if (!this.completedLessons.includes(lessonId)) {
                    this.completedLessons.push(lessonId);
                    this.saveProgress();
                }
                
                // Prepare content
                const readingTime = this.estimateReadingTime(lesson.body);
                const isBookmarked = this.bookmarks.includes(lessonId);
                
                document.getElementById('lesson-content').innerHTML = `
                    <div class="p-8 content-fade-in">
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h2 class="text-3xl font-bold text-gray-900 mb-2">
                                        Dars ${index + 1}
                                    </h2>
                                    <div class="flex items-center space-x-4 text-sm text-gray-500">
                                        <span><i class="fas fa-clock mr-1"></i>${readingTime} daqiqa</span>
                                        <span><i class="fas fa-calendar mr-1"></i>${new Date(lesson.created_at).toLocaleDateString('uz-UZ')}</span>
                                        ${this.completedLessons.includes(lessonId) ? '<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>Yakunlangan</span>' : ''}
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm font-medium">
                                        ${this.currentChapter.title}
                                    </span>
                                    <span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm">
                                        ${index + 1} / ${this.lessons.length}
                                    </span>
                                </div>
                            </div>
                            <div class="h-px bg-gray-200 mb-6"></div>
                        </div>
                        
                        <div class="lesson-content prose max-w-none" style="font-size: ${this.settings.fontSize}px;">
                            ${lesson.body}
                        </div>
                        
                        <div class="mt-12 pt-8 border-t border-gray-200">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4 text-sm text-gray-500">
                                    <span><i class="fas fa-calendar mr-1"></i>Yaratilgan: ${new Date(lesson.created_at).toLocaleDateString('uz-UZ')}</span>
                                    <span><i class="fas fa-edit mr-1"></i>Yangilangan: ${new Date(lesson.updated_at).toLocaleDateString('uz-UZ')}</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button class="lesson-action-btn px-3 py-1 text-sm text-gray-600 hover:text-indigo-600 transition-colors" onclick="app.shareLesson()">
                                        <i class="fas fa-share mr-1"></i>Ulashish
                                    </button>
                                    <button class="lesson-action-btn px-3 py-1 text-sm text-gray-600 hover:text-indigo-600 transition-colors" onclick="app.printLesson()">
                                        <i class="fas fa-print mr-1"></i>Chop etish
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Update header info
                document.getElementById('reading-time').classList.remove('hidden');
                document.getElementById('reading-time').querySelector('span').textContent = `${readingTime} daqiqa`;
                document.getElementById('lesson-counter').textContent = `${index + 1} / ${this.lessons.length}`;
                
                // Update bookmark button
                const bookmarkBtn = document.getElementById('bookmark-current');
                bookmarkBtn.classList.toggle('bookmarked', isBookmarked);
                
                // Load notes for this lesson
                this.loadLessonNotes(lessonId);
                
                // Update active states
                this.updateActiveLessonStates(index);
                this.updateNavigationButtons();
                this.updateProgress();
                
                // Auto-close mobile sidebar
                this.closeMobileSidebar();
                
                // Scroll to top
                document.querySelector('.flex-1.overflow-y-auto').scrollTop = 0;
            }

            // Utility Methods
            estimateReadingTime(content) {
                const wordsPerMinute = 200;
                const textContent = content.replace(/<[^>]*>/g, '');
                const wordCount = textContent.split(/\s+/).length;
                return Math.max(1, Math.ceil(wordCount / wordsPerMinute));
            }

            getLessonId(lesson, index) {
                return `${this.currentChapter.id}-${lesson.id || index}`;
            }

            updateActiveLessonStates(index) {
                document.querySelectorAll('.lesson-link').forEach((link, i) => {
                    link.classList.toggle('bg-indigo-600', i === index);
                    link.classList.toggle('text-white', i === index);
                    link.classList.toggle('text-gray-300', i !== index);
                });
            }

            updateActiveStates(chapterId) {
                document.querySelectorAll('.chapter-link').forEach(link => {
                    const isActive = link.dataset.chapterId == chapterId;
                    link.classList.toggle('bg-indigo-600', isActive);
                    link.classList.toggle('text-white', isActive);
                    link.classList.toggle('text-gray-300', !isActive);
                });
            }

            updateNavigationButtons() {
                const prevBtn = document.getElementById('prev-lesson');
                const nextBtn = document.getElementById('next-lesson');
                
                prevBtn.disabled = this.currentLessonIndex === 0;
                nextBtn.disabled = this.currentLessonIndex === this.lessons.length - 1;
            }

            updateProgress() {
                const totalLessons = this.chapters.reduce((sum, chapter) => {
                    const lessonsData = JSON.parse(localStorage.getItem('lessons_data'));
                    return sum + (lessonsData[chapter.id]?.length || 0);
                }, 0);
                
                const completed = this.completedLessons.length;
                const percentage = totalLessons > 0 ? Math.round((completed / totalLessons) * 100) : 0;
                
                // Update circular progress
                const circle = document.getElementById('progress-circle');
                const circumference = 2 * Math.PI * 14;
                const offset = circumference - (percentage / 100) * circumference;
                circle.style.strokeDashoffset = offset;
                
                // Update text
                document.getElementById('progress-percent').textContent = `${percentage}%`;
                document.getElementById('completed-lessons').textContent = completed;
                document.getElementById('total-lessons').textContent = totalLessons;
            }

            // Event Listeners Setup
            setupEventListeners() {
                // Chapter and lesson navigation
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.chapter-link')) {
                        e.preventDefault();
                        const chapterId = e.target.closest('.chapter-link').dataset.chapterId;
                        this.loadChapterLessons(parseInt(chapterId));
                    }
                    
                    if (e.target.closest('.lesson-link')) {
                        e.preventDefault();
                        const lessonIndex = e.target.closest('.lesson-link').dataset.lessonIndex;
                        this.showLesson(parseInt(lessonIndex));
                    }
                });
                
                // Navigation buttons
                document.getElementById('prev-lesson').addEventListener('click', () => {
                    if (this.currentLessonIndex > 0) {
                        this.showLesson(this.currentLessonIndex - 1);
                    }
                });
                
                document.getElementById('next-lesson').addEventListener('click', () => {
                    if (this.currentLessonIndex < this.lessons.length - 1) {
                        this.showLesson(this.currentLessonIndex + 1);
                    }
                });
                
                // Search functionality
                this.setupSearch();
                
                // Bookmark functionality
                this.setupBookmarks();
                
                // Notes functionality
                this.setupNotes();
                
                // Font size controls
                this.setupFontControls();
                
                // Print functionality
                document.getElementById('print-btn').addEventListener('click', () => this.printLesson());
                
                // Fullscreen functionality
                document.getElementById('fullscreen-btn').addEventListener('click', () => this.toggleFullscreen());
            }

            setupSearch() {
                const searchInput = document.getElementById('search-input');
                const clearBtn = document.getElementById('clear-search');
                
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    
                    clearBtn.classList.toggle('hidden', !searchTerm);
                    
                    if (searchTerm) {
                        this.performSearch(searchTerm);
                    } else {
                        this.clearSearch();
                    }
                });
                
                clearBtn.addEventListener('click', () => {
                    searchInput.value = '';
                    this.clearSearch();
                    clearBtn.classList.add('hidden');
                });
            }

            performSearch(term) {
                document.querySelectorAll('.chapter-link, .lesson-link').forEach(link => {
                    const text = link.textContent.toLowerCase();
                    const matches = text.includes(term);
                    link.style.display = matches ? 'flex' : 'none';
                    
                    if (matches) {
                        link.style.backgroundColor = '#3b82f6';
                        link.style.color = 'white';
                    }
                });
            }

            clearSearch() {
                document.querySelectorAll('.chapter-link, .lesson-link').forEach(link => {
                    link.style.display = 'flex';
                    if (!link.classList.contains('bg-indigo-600')) {
                        link.style.backgroundColor = '';
                        link.style.color = '';
                    }
                });
            }

            setupBookmarks() {
                document.getElementById('bookmark-current').addEventListener('click', () => {
                    if (this.currentChapter && this.lessons.length > 0) {
                        const lessonId = this.getLessonId(this.lessons[this.currentLessonIndex], this.currentLessonIndex);
                        this.toggleBookmark(lessonId);
                    }
                });
                
                document.getElementById('bookmark-btn').addEventListener('click', () => {
                    this.showBookmarks();
                });
            }

            toggleBookmark(lessonId) {
                const index = this.bookmarks.indexOf(lessonId);
                const bookmarkBtn = document.getElementById('bookmark-current');
                
                if (index > -1) {
                    this.bookmarks.splice(index, 1);
                    bookmarkBtn.classList.remove('bookmarked');
                } else {
                    this.bookmarks.push(lessonId);
                    bookmarkBtn.classList.add('bookmarked');
                }
                
                this.saveBookmarks();
                this.generateLessonsList(); // Refresh to show bookmark icons
            }

            setupNotes() {
                document.getElementById('notes-btn').addEventListener('click', () => {
                    this.toggleNotesPanel();
                });
                
                document.getElementById('close-notes').addEventListener('click', () => {
                    this.toggleNotesPanel(false);
                });
                
                document.getElementById('save-notes').addEventListener('click', () => {
                    this.saveLessonNotes();
                });
            }

            toggleNotesPanel(show = null) {
                const panel = document.getElementById('notes-panel');
                const isOpen = show !== null ? show : !panel.classList.contains('open');
                
                panel.classList.toggle('open', isOpen);
                
                if (isOpen && this.currentChapter && this.lessons.length > 0) {
                    const lessonId = this.getLessonId(this.lessons[this.currentLessonIndex], this.currentLessonIndex);
                    this.loadLessonNotes(lessonId);
                }
            }

            loadLessonNotes(lessonId) {
                const notes = this.notes[lessonId] || '';
                document.getElementById('lesson-notes').value = notes;
            }

            saveLessonNotes() {
                if (this.currentChapter && this.lessons.length > 0) {
                    const lessonId = this.getLessonId(this.lessons[this.currentLessonIndex], this.currentLessonIndex);
                    const notesText = document.getElementById('lesson-notes').value;
                    
                    if (notesText.trim()) {
                        this.notes[lessonId] = notesText;
                    } else {
                        delete this.notes[lessonId];
                    }
                    
                    this.saveNotes();
                    this.generateLessonsList(); // Refresh to show notes icons
                    
                    // Show success message
                    this.showToast('Eslatma saqlandi', 'success');
                }
            }

            setupFontControls() {
                document.getElementById('font-size-btn').addEventListener('click', () => {
                    document.getElementById('font-modal').classList.remove('hidden');
                });
                
                document.getElementById('close-font-modal').addEventListener('click', () => {
                    document.getElementById('font-modal').classList.add('hidden');
                });
                
                document.getElementById('font-range').addEventListener('input', (e) => {
                    const fontSize = e.target.value;
                    this.settings.fontSize = fontSize;
                    this.applyFontSize(fontSize);
                    this.saveSettings();
                });
                
                document.getElementById('reset-font').addEventListener('click', () => {
                    this.settings.fontSize = 16;
                    this.applyFontSize(16);
                    document.getElementById('font-range').value = 16;
                    this.saveSettings();
                });
            }

            applyFontSize(size) {
                const content = document.querySelector('.lesson-content');
                if (content) {
                    content.style.fontSize = `${size}px`;
                }
            }

            // Mobile Menu Setup
            setupMobileMenu() {
                const mobileBtn = document.getElementById('mobile-menu-btn');
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                const closeBtn = document.getElementById('close-sidebar');
                
                mobileBtn.addEventListener('click', () => {
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                });
                
                [closeBtn, overlay].forEach(el => {
                    el.addEventListener('click', () => this.closeMobileSidebar());
                });
            }

            closeMobileSidebar() {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('sidebar-overlay').classList.add('hidden');
            }

            // Dropdown Setup
            setupDropdowns() {
                document.querySelectorAll('button[aria-controls]').forEach(button => {
                    button.addEventListener('click', () => {
                        const isExpanded = button.getAttribute('aria-expanded') === 'true';
                        const dropdownContent = document.getElementById(button.getAttribute('aria-controls'));
                        const arrow = button.querySelector('.dropdown-arrow');
                        
                        button.setAttribute('aria-expanded', !isExpanded);
                        dropdownContent.classList.toggle('hidden');
                        if (arrow) arrow.classList.toggle('rotate');
                    });
                });
            }

            // Keyboard Shortcuts
            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                    
                    switch(e.key) {
                        case 'ArrowLeft':
                            if (!document.getElementById('prev-lesson').disabled) {
                                this.showLesson(this.currentLessonIndex - 1);
                            }
                            break;
                        case 'ArrowRight':
                            if (!document.getElementById('next-lesson').disabled) {
                                this.showLesson(this.currentLessonIndex + 1);
                            }
                            break;
                        case 'b':
                            if (e.ctrlKey || e.metaKey) {
                                e.preventDefault();
                                document.getElementById('bookmark-current').click();
                            }
                            break;
                        case 'n':
                            if (e.ctrlKey || e.metaKey) {
                                e.preventDefault();
                                this.toggleNotesPanel();
                            }
                            break;
                        case 'f':
                            if (e.ctrlKey || e.metaKey) {
                                e.preventDefault();
                                document.getElementById('search-input').focus();
                            }
                            break;
                        case 'Escape':
                            this.closeMobileSidebar();
                            document.getElementById('font-modal').classList.add('hidden');
                            document.getElementById('admin-modal').classList.add('hidden');
                            document.getElementById('lesson-editor-modal').classList.add('hidden');
                            this.toggleNotesPanel(false);
                            break;
                    }
                });
            }

            // Auto-save Setup
            setupAutoSave() {
                setInterval(() => {
                    const notesText = document.getElementById('lesson-notes').value;
                    if (notesText && this.currentChapter && this.lessons.length > 0) {
                        const lessonId = this.getLessonId(this.lessons[this.currentLessonIndex], this.currentLessonIndex);
                        if (this.notes[lessonId] !== notesText) {
                            this.saveLessonNotes();
                        }
                    }
                }, 10000); // Auto-save every 10 seconds
            }

            // Admin Panel Setup
            setupAdminPanel() {
                // Add admin button to user profile section
                const userSection = document.querySelector('.mt-auto.p-4.border-t');
                const adminBtn = document.createElement('button');
                adminBtn.className = 'ml-2 text-gray-400 hover:text-white';
                adminBtn.innerHTML = '<i class="fas fa-tools"></i>';
                adminBtn.title = 'Ma\'lumotlarni boshqarish';
                userSection.querySelector('.flex.items-center').appendChild(adminBtn);
                
                // Admin button click event
                adminBtn.addEventListener('click', () => {
                    this.openAdminPanel();
                });
                
                // Close admin modal
                document.getElementById('close-admin-modal').addEventListener('click', () => {
                    document.getElementById('admin-modal').classList.add('hidden');
                });
                
                // Save data button
                document.getElementById('save-data-btn').addEventListener('click', () => {
                    this.saveAdminData();
                });
                
                // Reset data button
                document.getElementById('reset-data-btn').addEventListener('click', () => {
                    if (confirm('Barcha ma\'lumotlarni tozalashni xohlaysizmi? Bu amalni qaytarib bo\'lmaydi.')) {
                        localStorage.removeItem('course_data');
                        localStorage.removeItem('chapters_data');
                        localStorage.removeItem('lessons_data');
                        this.initializeLocalStorage();
                        this.loadCourse();
                        this.loadChapters();
                        this.showToast('Ma\'lumotlar qayta tiklandi', 'success');
                        document.getElementById('admin-modal').classList.add('hidden');
                    }
                });
                
                // Add chapter button
                document.getElementById('add-chapter-btn').addEventListener('click', () => {
                    this.addNewChapter();
                });
                
                // Chapter select change
                document.getElementById('chapter-select').addEventListener('change', (e) => {
                    const chapterId = parseInt(e.target.value);
                    document.getElementById('add-lesson-btn').disabled = !chapterId;
                    
                    if (chapterId) {
                        this.loadAdminLessons(chapterId);
                    } else {
                        document.getElementById('admin-lessons-list').innerHTML = '';
                    }
                });
                
                // Add lesson button
                document.getElementById('add-lesson-btn').addEventListener('click', () => {
                    const chapterId = parseInt(document.getElementById('chapter-select').value);
                    if (chapterId) {
                        this.openLessonEditor(chapterId);
                    }
                });
                
                // Export data button
                document.getElementById('export-data-btn').addEventListener('click', () => {
                    this.exportData();
                });
                
                // Import data button
                document.getElementById('import-data-btn').addEventListener('click', () => {
                    document.getElementById('import-file').click();
                });
                
                // Import file change
                document.getElementById('import-file').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.importData(file);
                    }
                });
                
                // Lesson editor
                document.getElementById('close-lesson-editor').addEventListener('click', () => {
                    document.getElementById('lesson-editor-modal').classList.add('hidden');
                });
                
                document.getElementById('save-lesson-edit').addEventListener('click', () => {
                    this.saveLessonEdit();
                });
                
                document.getElementById('cancel-lesson-edit').addEventListener('click', () => {
                    document.getElementById('lesson-editor-modal').classList.add('hidden');
                });
            }

            openAdminPanel() {
                // Load current course data
                const courseData = JSON.parse(localStorage.getItem('course_data'));
                document.getElementById('admin-course-title').value = courseData.title;
                document.getElementById('admin-course-body').value = courseData.body;
                
                // Load chapters
                this.loadAdminChapters();
                
                // Populate chapter select
                const chapters = JSON.parse(localStorage.getItem('chapters_data'));
                const chapterSelect = document.getElementById('chapter-select');
                chapterSelect.innerHTML = '<option value="">Bob tanlang</option>';
                
                chapters.forEach(chapter => {
                    const option = document.createElement('option');
                    option.value = chapter.id;
                    option.textContent = chapter.title;
                    chapterSelect.appendChild(option);
                });
                
                // Show modal
                document.getElementById('admin-modal').classList.remove('hidden');
            }

            loadAdminChapters() {
                const chapters = JSON.parse(localStorage.getItem('chapters_data'));
                const chaptersList = document.getElementById('admin-chapters-list');
                
                chaptersList.innerHTML = chapters.map((chapter, index) => `
                    <div class="flex items-center justify-between p-2 bg-gray-100 rounded">
                        <div class="flex items-center">
                            <span class="font-medium">${index + 1}. ${chapter.title}</span>
                            <span class="ml-2 text-xs text-gray-500">(${this.getChapterLessonCount(chapter.id)} dars)</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <button class="p-1 text-blue-600 hover:text-blue-800" onclick="app.editChapter(${chapter.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="p-1 text-red-600 hover:text-red-800" onclick="app.deleteChapter(${chapter.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            getChapterLessonCount(chapterId) {
                const lessonsData = JSON.parse(localStorage.getItem('lessons_data'));
                return lessonsData[chapterId]?.length || 0;
            }

            loadAdminLessons(chapterId) {
                const lessonsData = JSON.parse(localStorage.getItem('lessons_data'));
                const lessons = lessonsData[chapterId] || [];
                const lessonsList = document.getElementById('admin-lessons-list');
                
                lessonsList.innerHTML = lessons.map((lesson, index) => `
                    <div class="flex items-center justify-between p-2 bg-gray-100 rounded">
                        <div class="flex items-center">
                            <span class="font-medium">Dars ${index + 1}</span>
                            <span class="ml-2 text-xs text-gray-500">(${this.estimateReadingTime(lesson.body)} min)</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <button class="p-1 text-blue-600 hover:text-blue-800" onclick="app.editLesson(${chapterId}, ${index})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="p-1 text-red-600 hover:text-red-800" onclick="app.deleteLesson(${chapterId}, ${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            addNewChapter() {
                const title = prompt('Yangi bob nomini kiriting:');
                if (title && title.trim()) {
                    const chapters = JSON.parse(localStorage.getItem('chapters_data'));
                    const newId = Math.max(0, ...chapters.map(c => c.id)) + 1;
                    
                    chapters.push({
                        id: newId,
                        title: title.trim(),
                        lessonCount: 0
                    });
                    
                    localStorage.setItem('chapters_data', JSON.stringify(chapters));
                    this.loadAdminChapters();
                    
                    // Update chapter select
                    const chapterSelect = document.getElementById('chapter-select');
                    const option = document.createElement('option');
                    option.value = newId;
                    option.textContent = title.trim();
                    chapterSelect.appendChild(option);
                    
                    this.showToast('Yangi bob qo\'shildi', 'success');
                }
            }

            editChapter(chapterId) {
                const chapters = JSON.parse(localStorage.getItem('chapters_data'));
                const chapter = chapters.find(c => c.id === chapterId);
                
                if (chapter) {
                    const newTitle = prompt('Bob nomini tahrirlang:', chapter.title);
                    if (newTitle && newTitle.trim()) {
                        chapter.title = newTitle.trim();
                        localStorage.setItem('chapters_data', JSON.stringify(chapters));
                        this.loadAdminChapters();
                        
                        // Update chapter select
                        const options = document.getElementById('chapter-select').options;
                        for (let i = 0; i < options.length; i++) {
                            if (options[i].value == chapterId) {
                                options[i].textContent = newTitle.trim();
                                break;
                            }
                        }
                        
                        this.showToast('Bob tahrirlandi', 'success');
                    }
                }
            }

            deleteChapter(chapterId) {
                if (confirm('Bu bobni o\'chirishni xohlaysizmi? Barcha darslar ham o\'chiriladi.')) {
                    const chapters = JSON.parse(localStorage.getItem('chapters_data'));
                    const newChapters = chapters.filter(c => c.id !== chapterId);
                    
                    localStorage.setItem('chapters_data', JSON.stringify(newChapters));
                    
                    // Remove lessons for this chapter
                    const lessonsData = JSON.parse(localStorage.getItem('lessons_data'));
                    delete lessonsData[chapterId];
                    localStorage.setItem('lessons_data', JSON.stringify(lessonsData));
                    
                    this.loadAdminChapters();
                    
                    // Update chapter select
                    const options = document.getElementById('chapter-select').options;
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].value == chapterId) {
                            options[i].remove();
                            break;
                        }
                    }
                    
                    this.showToast('Bob o\'chirildi', 'success');
                }
            }

            openLessonEditor(chapterId, lessonIndex = null) {
                const lessonsData = JSON.parse(localStorage.getItem('lessons_data'));
                const lessons = lessonsData[chapterId] || [];
                
                document.getElementById('lesson-editor-title').textContent = lessonIndex !== null ? 'Darsni tahrirlash' : 'Yangi dars qo\'shish';
                
                if (lessonIndex !== null && lessons[lessonIndex]) {
                    document.getElementById('lesson-editor-number').value = lessonIndex + 1;
                    document.getElementById('lesson-editor-body').value = lessons[lessonIndex].body;
                } else {
                    document.getElementById('lesson-editor-number').value = lessons.length + 1;
                    document.getElementById('lesson-editor-body').value = '<h1>Yangi dars</h1><p>Dars matni...</p>';
                }
                
                // Store current editing info
                this.editingLesson = {
                    chapterId,
                    lessonIndex
                };
                
                document.getElementById('lesson-editor-modal').classList.remove('hidden');
            }

            saveLessonEdit() {
                const { chapterId, lessonIndex } = this.editingLesson;
                const lessonNumber = parseInt(document.getElementById('lesson-editor-number').value) - 1;
                const lessonBody = document.getElementById('lesson-editor-body').value;
                
                if (!lessonBody.trim()) {
                    this.showToast('Dars matni bo\'sh bo\'lishi mumkin emas', 'error');
                    return;
                }
                
                const lessonsData = JSON.parse(localStorage.getItem('lessons_data'));
                if (!lessonsData[chapterId]) {
                    lessonsData[chapterId] = [];
                }
                
                const now = new Date().toISOString();
                
                if (lessonIndex !== null) {
                    // Editing existing lesson
                    const lesson = lessonsData[chapterId][lessonIndex];
                    lesson.body = lessonBody;
                    lesson.updated_at = now;
                    
                    // Handle reordering if lesson number changed
                    if (lessonNumber !== lessonIndex) {
                        const movedLesson = lessonsData[chapterId].splice(lessonIndex, 1)[0];
                        lessonsData[chapterId].splice(lessonNumber, 0, movedLesson);
                    }
                } else {
                    // Adding new lesson
                    const newLesson = {
                        id: Math.max(0, ...lessonsData[chapterId].map(l => l.id || 0)) + 1,
                        body: lessonBody,
                        created_at: now,
                        updated_at: now
                    };
                    
                    lessonsData[chapterId].splice(lessonNumber, 0, newLesson);
                }
                
                localStorage.setItem('lessons_data', JSON.stringify(lessonsData));
                this.loadAdminLessons(chapterId);
                
                document.getElementById('lesson-editor-modal').classList.add('hidden');
                this.showToast('Dars saqlandi', 'success');
            }

            editLesson(chapterId, lessonIndex) {
                this.openLessonEditor(chapterId, lessonIndex);
            }

            deleteLesson(chapterId, lessonIndex) {
                if (confirm('Bu darsni o\'chirishni xohlaysizmi?')) {
                    const lessonsData = JSON.parse(localStorage.getItem('lessons_data'));
                    
                    if (lessonsData[chapterId] && lessonsData[chapterId][lessonIndex]) {
                        lessonsData[chapterId].splice(lessonIndex, 1);
                        localStorage.setItem('lessons_data', JSON.stringify(lessonsData));
                        
                        this.loadAdminLessons(chapterId);
                        this.showToast('Dars o\'chirildi', 'success');
                    }
                }
            }

            saveAdminData() {
                // Save course data
                const courseData = JSON.parse(localStorage.getItem('course_data'));
                courseData.title = document.getElementById('admin-course-title').value;
                courseData.body = document.getElementById('admin-course-body').value;
                localStorage.setItem('course_data', JSON.stringify(courseData));
                
                // Reload data
                this.loadCourse();
                this.loadChapters();
                
                document.getElementById('admin-modal').classList.add('hidden');
                this.showToast('Ma\'lumotlar saqlandi', 'success');
            }

            exportData() {
                const exportData = {
                    course: JSON.parse(localStorage.getItem('course_data')),
                    chapters: JSON.parse(localStorage.getItem('chapters_data')),
                    lessons: JSON.parse(localStorage.getItem('lessons_data')),
                    bookmarks: this.bookmarks,
                    notes: this.notes,
                    completedLessons: this.completedLessons,
                    settings: this.settings
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = 'darslik_data.json';
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            }

            importData(file) {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.course && data.chapters && data.lessons) {
                            localStorage.setItem('course_data', JSON.stringify(data.course));
                            localStorage.setItem('chapters_data', JSON.stringify(data.chapters));
                            localStorage.setItem('lessons_data', JSON.stringify(data.lessons));
                            
                            if (data.bookmarks) this.bookmarks = data.bookmarks;
                            if (data.notes) this.notes = data.notes;
                            if (data.completedLessons) this.completedLessons = data.completedLessons;
                            if (data.settings) this.settings = data.settings;
                            
                            this.saveBookmarks();
                            this.saveNotes();
                            this.saveProgress();
                            this.saveSettings();
                            
                            this.loadCourse();
                            this.loadChapters();
                            
                            this.showToast('Ma\'lumotlar muvaffaqiyatli import qilindi', 'success');
                        } else {
                            throw new Error('Noto\'g\'ri fayl formati');
                        }
                    } catch (error) {
                        console.error('Import xatosi:', error);
                        this.showError('Ma\'lumotlarni import qilishda xatolik yuz berdi');
                    }
                };
                
                reader.readAsText(file);
            }

            // Additional Features
            printLesson() {
                const content = document.querySelector('.lesson-content').innerHTML;
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Dars ${this.currentLessonIndex + 1} - ${this.currentChapter.title}</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 40px; }
                                img { max-width: 100%; height: auto; }
                                table { width: 100%; border-collapse: collapse; }
                                table td { padding: 8px; border: 1px solid #ddd; }
                            </style>
                        </head>
                        <body>
                            <h1>Dars ${this.currentLessonIndex + 1}</h1>
                            <h2>${this.currentChapter.title}</h2>
                            ${content}
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }

            shareLesson() {
                if (navigator.share) {
                    navigator.share({
                        title: `Dars ${this.currentLessonIndex + 1} - ${this.currentChapter.title}`,
                        text: 'Bu darsni ko\'ring',
                        url: window.location.href
                    });
                } else {
                    // Fallback: copy to clipboard
                    navigator.clipboard.writeText(window.location.href);
                    this.showToast('Havola nusxalandi', 'success');
                }
            }

            toggleFullscreen() {
                const content = document.getElementById('lesson-content');
                if (content.classList.contains('fullscreen-reading')) {
                    content.classList.remove('fullscreen-reading');
                } else {
                    content.classList.add('fullscreen-reading');
                }
            }

            // Local Storage Methods
            loadBookmarks() {
                return JSON.parse(localStorage.getItem('course_bookmarks')) || [];
            }

            saveBookmarks() {
                localStorage.setItem('course_bookmarks', JSON.stringify(this.bookmarks));
            }

            loadNotes() {
                return JSON.parse(localStorage.getItem('course_notes')) || {};
            }

            saveNotes() {
                localStorage.setItem('course_notes', JSON.stringify(this.notes));
            }

            loadProgress() {
                return JSON.parse(localStorage.getItem('course_progress')) || [];
            }

            saveProgress() {
                localStorage.setItem('course_progress', JSON.stringify(this.completedLessons));
            }

            loadSettings() {
                return JSON.parse(localStorage.getItem('course_settings')) || { fontSize: 16 };
            }

            saveSettings() {
                localStorage.setItem('course_settings', JSON.stringify(this.settings));
            }

            applySettings() {
                document.getElementById('font-range').value = this.settings.fontSize;
                this.applyFontSize(this.settings.fontSize);
            }

            // Utility Methods
            showLoadingSpinner() {
                // Implementation for loading spinner
            }

            hideLoadingSpinner() {
                // Implementation for hiding loading spinner
            }

            showError(message) {
                this.showToast(message, 'error');
            }

            showToast(message, type = 'info') {
                // Simple toast implementation
                const toast = document.createElement('div');
                toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white ${
                    type === 'success' ? 'bg-green-500' : 
                    type === 'error' ? 'bg-red-500' : 'bg-blue-500'
                }`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            showBookmarks() {
                if (this.bookmarks.length === 0) {
                    this.showToast('Xatcho\'plar mavjud emas', 'info');
                    return;
                }
                
                // Create a modal for bookmarks
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
                
                const content = document.createElement('div');
                content.className = 'bg-white rounded-lg p-6 w-full max-w-md max-h-[80vh] overflow-y-auto';
                
                const header = document.createElement('div');
                header.className = 'flex items-center justify-between mb-4';
                header.innerHTML = `
                    <h3 class="text-lg font-medium">Xatcho'plar</h3>
                    <button id="close-bookmarks" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                const bookmarksList = document.createElement('div');
                bookmarksList.className = 'space-y-2';
                
                // Generate bookmarks list
                let bookmarksHTML = '';
                for (const bookmark of this.bookmarks) {
                    const [chapterId, lessonId] = bookmark.split('-');
                    const chapter = this.chapters.find(c => c.id === parseInt(chapterId));
                    
                    if (chapter) {
                        const lessonsData = JSON.parse(localStorage.getItem('lessons_data'));
                        const lessons = lessonsData[chapterId] || [];
                        const lessonIndex = lessons.findIndex(l => l.id === parseInt(lessonId));
                        
                        if (lessonIndex !== -1) {
                            bookmarksHTML += `
                                <div class="flex items-center justify-between p-2 bg-gray-100 rounded hover:bg-gray-200 cursor-pointer bookmark-item" data-chapter-id="${chapterId}" data-lesson-index="${lessonIndex}">
                                    <div>
                                        <div class="font-medium">${chapter.title}</div>
                                        <div class="text-sm text-gray-600">Dars ${lessonIndex + 1}</div>
                                    </div>
                                    <button class="p-1 text-red-600 hover:text-red-800 remove-bookmark" data-bookmark="${bookmark}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                        }
                    }
                }
                
                bookmarksList.innerHTML = bookmarksHTML || '<p class="text-center text-gray-500">Xatcho\'plar mavjud emas</p>';
                
                content.appendChild(header);
                content.appendChild(bookmarksList);
                modal.appendChild(content);
                
                document.body.appendChild(modal);
                
                // Event listeners
                document.getElementById('close-bookmarks').addEventListener('click', () => {
                    modal.remove();
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
                document.querySelectorAll('.bookmark-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (!e.target.closest('.remove-bookmark')) {
                            const chapterId = parseInt(item.dataset.chapterId);
                            const lessonIndex = parseInt(item.dataset.lessonIndex);
                            
                            this.loadChapterLessons(chapterId).then(() => {
                                this.showLesson(lessonIndex);
                                modal.remove();
                            });
                        }
                    });
                });
                
                document.querySelectorAll('.remove-bookmark').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const bookmark = btn.dataset.bookmark;
                        const index = this.bookmarks.indexOf(bookmark);
                        
                        if (index > -1) {
                            this.bookmarks.splice(index, 1);
                            this.saveBookmarks();
                            btn.closest('.bookmark-item').remove();
                            
                            if (document.querySelectorAll('.bookmark-item').length === 0) {
                                bookmarksList.innerHTML = '<p class="text-center text-gray-500">Xatcho\'plar mavjud emas</p>';
                            }
                            
                            this.showToast('Xatcho\'p o\'chirildi', 'success');
                        }
                    });
                });
            }
        }

        // Initialize app
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new AdvancedCourseApp();
        });
    </script>
</body>
</html>